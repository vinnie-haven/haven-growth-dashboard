<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Haven Energy — Growth Marketing Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<style>
  :root {
    --bg: #0a0f1a; --surface: #111827; --surface2: #1a2234; --border: #1e2d44;
    --text: #e2e8f0; --text-dim: #8896aa; --accent: #22d3a7; --accent2: #3b82f6;
    --accent3: #f59e0b; --purple: #a855f7; --pink: #ec4899; --red: #ef4444; --green: #22c55e;
    --font: 'DM Sans', sans-serif; --mono: 'Space Mono', monospace;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:var(--font); min-height:100vh; }

  .topbar { display:flex; align-items:center; justify-content:space-between; padding:16px 32px; border-bottom:1px solid var(--border); background:var(--surface); }
  .topbar-left { display:flex; align-items:center; gap:16px; }
  .logo { font-family:var(--mono); font-size:13px; font-weight:700; color:var(--accent); letter-spacing:2px; text-transform:uppercase; }
  .topbar-title { font-size:15px; font-weight:500; color:var(--text-dim); }
  .topbar-right { display:flex; align-items:center; gap:12px; }
  .sync-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text-dim); font-family:var(--font); font-size:13px; padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.2s; }
  .sync-btn:hover { border-color:var(--accent); color:var(--accent); }
  .sync-btn.syncing { color:var(--accent); border-color:var(--accent); opacity:0.7; cursor:wait; }
  .sync-status { font-family:var(--mono); font-size:11px; color:var(--text-dim); }

  .controls { display:flex; align-items:center; justify-content:space-between; padding:20px 32px; gap:16px; flex-wrap:wrap; }
  .period-toggle { display:flex; background:var(--surface); border-radius:10px; padding:3px; border:1px solid var(--border); }
  .period-toggle button { background:transparent; border:none; color:var(--text-dim); font-family:var(--font); font-size:13px; font-weight:500; padding:8px 20px; border-radius:8px; cursor:pointer; transition:all 0.2s; }
  .period-toggle button.active { background:var(--accent); color:#0a0f1a; font-weight:600; }

  .period-nav { display:flex; align-items:center; gap:12px; }
  .period-nav button { background:var(--surface); border:1px solid var(--border); color:var(--text); width:36px; height:36px; border-radius:8px; cursor:pointer; font-size:16px; transition:all 0.2s; display:flex; align-items:center; justify-content:center; }
  .period-nav button:hover { border-color:var(--accent); }
  .period-label { font-family:var(--mono); font-size:14px; font-weight:700; min-width:200px; text-align:center; }

  .exclude-toggle { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-dim); }
  .exclude-toggle input { accent-color:var(--accent); width:16px; height:16px; }

  .main { padding:0 32px 40px; }

  .kpi-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:16px; margin-bottom:28px; }
  .kpi-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:20px; position:relative; overflow:hidden; transition:border-color 0.2s; }
  .kpi-card:hover { border-color:var(--accent); }
  .kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
  .kpi-card:nth-child(1)::before { background:var(--accent); }
  .kpi-card:nth-child(2)::before { background:var(--accent2); }
  .kpi-card:nth-child(3)::before { background:var(--accent3); }
  .kpi-card:nth-child(4)::before { background:var(--purple); }
  .kpi-card:nth-child(5)::before { background:var(--pink); }
  .kpi-card:nth-child(6)::before { background:#f43f5e; }
  .kpi-label { font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:1px; color:var(--text-dim); margin-bottom:10px; }
  .kpi-value { font-family:var(--mono); font-size:32px; font-weight:700; line-height:1; margin-bottom:8px; }
  .kpi-change { font-family:var(--mono); font-size:12px; font-weight:700; }
  .kpi-change.up { color:var(--green); }
  .kpi-change.down { color:var(--red); }
  .kpi-change.flat { color:var(--text-dim); }
  .kpi-prev { font-size:11px; color:var(--text-dim); margin-top:2px; }

  .charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:28px; }
  .charts-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:28px; }
  .chart-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:24px; }
  .chart-title { font-size:14px; font-weight:600; margin-bottom:16px; }
  .chart-container { position:relative; height:280px; }

  .funnel-stages { display:flex; flex-direction:column; gap:8px; }
  .funnel-stage { display:flex; align-items:center; gap:10px; }
  .funnel-stage-name { font-size:12px; font-weight:600; color:var(--text-dim); width:64px; text-align:right; }
  .funnel-bar-wrap { flex:1; height:38px; background:var(--surface2); border-radius:8px; overflow:hidden; }
  .funnel-bar { height:100%; border-radius:8px; transition:width 0.6s ease; display:flex; align-items:center; padding-left:12px; min-width:36px; }
  .funnel-bar-label { font-family:var(--mono); font-size:12px; font-weight:700; color:#0a0f1a; white-space:nowrap; }
  .funnel-arrow { text-align:center; color:var(--text-dim); font-size:11px; padding-left:74px; font-family:var(--mono); }

  .table-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:24px; overflow-x:auto; }
  .table-card table { width:100%; border-collapse:collapse; }
  .table-card th { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:1px; color:var(--text-dim); text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); }
  .table-card td { padding:10px 12px; font-family:var(--mono); font-size:12px; border-bottom:1px solid var(--border); }
  .table-card tr:last-child td { border-bottom:none; }
  .table-card tr:hover td { background:var(--surface2); }
  .mini-bar { display:inline-block; height:6px; border-radius:3px; margin-right:8px; vertical-align:middle; }

  /* Sync overlay */
  .sync-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(10,15,26,0.85); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity 0.3s; }
  .sync-overlay.show { opacity:1; pointer-events:all; }
  .sync-modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:32px 40px; max-width:420px; width:90%; text-align:center; }
  .sync-modal h3 { font-size:16px; margin-bottom:16px; }
  .sync-progress { font-family:var(--mono); font-size:13px; color:var(--accent); margin-bottom:8px; }
  .sync-detail { font-size:12px; color:var(--text-dim); margin-bottom:16px; }
  .sync-bar-track { height:6px; background:var(--surface2); border-radius:3px; overflow:hidden; }
  .sync-bar-fill { height:100%; background:var(--accent); border-radius:3px; transition:width 0.3s; }

  @media(max-width:1100px) { .kpi-grid{grid-template-columns:repeat(3,1fr);} .charts-grid{grid-template-columns:1fr;} .charts-row{grid-template-columns:1fr;} }
  @media(max-width:700px) { .kpi-grid{grid-template-columns:repeat(2,1fr);} .controls{flex-direction:column;align-items:flex-start;} .topbar,.main,.controls{padding-left:16px;padding-right:16px;} }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="logo">Haven Energy</div>
    <div class="topbar-title">Growth Marketing</div>
  </div>
  <div class="topbar-right">
    <button class="sync-btn" id="syncBtn" onclick="runSync()">⟳ Sync HubSpot</button>
    <span class="sync-status" id="syncStatus">Loading...</span>
  </div>
</div>

<div class="controls">
  <div class="period-toggle">
    <button class="active" onclick="setView('weekly')">Weekly</button>
    <button onclick="setView('monthly')">Monthly</button>
  </div>
  <div class="period-nav">
    <button onclick="navigatePeriod(-1)">←</button>
    <div class="period-label" id="periodLabel">—</div>
    <button onclick="navigatePeriod(1)">→</button>
  </div>
  <label class="exclude-toggle">
    <input type="checkbox" id="excludePartners" checked onchange="refresh()">
    Exclude partner sources
  </label>
</div>

<div class="main">
  <div class="kpi-grid" id="kpiGrid"></div>
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">MQLs</div>
      <div class="chart-container"><canvas id="chartMqls"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">SQLs</div>
      <div class="chart-container"><canvas id="chartSqls"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Meetings</div>
      <div class="chart-container"><canvas id="chartMtgs"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Sits</div>
      <div class="chart-container"><canvas id="chartSits"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Closes (Created)</div>
      <div class="chart-container"><canvas id="chartClosesCreated"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Closes (Won)</div>
      <div class="chart-container"><canvas id="chartClosesDeal"></canvas></div>
    </div>
  </div>
  <div class="charts-row">
    <div class="chart-card">
      <div class="chart-title">Conversion Funnel</div>
      <div class="funnel-stages" id="funnel"></div>
    </div>
  </div>
  <div class="table-card">
    <div class="chart-title" id="tableTitle">Breakdown by Week</div>
    <table><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
  </div>
</div>

<div class="sync-overlay" id="syncOverlay">
  <div class="sync-modal">
    <h3>Syncing HubSpot Data</h3>
    <div class="sync-progress" id="syncProgress">Initializing...</div>
    <div class="sync-detail" id="syncDetail">This may take a couple of minutes</div>
    <div class="sync-bar-track"><div class="sync-bar-fill" id="syncBar" style="width:0%"></div></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://vnxerxefgodekwjdxfqc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZueGVyeGVmZ29kZWt3amR4ZnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MjY3MjgsImV4cCI6MjA4NDEwMjcyOH0.yV2rEL6PDBW2qjctwsk67-l77miABQ0ssiI6MA2CfEo';
const FUNC_URL = SUPABASE_URL + '/functions/v1/sync-growth-marketing';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const PARTNER_SOURCES = ['PCE','CPA','QCS','Self-Generated','CEA','Baker','Skelly Electric','Taylor Energy','California Solar Electric','Blue Sky Center','EPX','SJCE'];

let contacts = [], meetings = [];
let viewMode = 'weekly', periodOffset = 0;
let charts = {};

// ========== DATA LOADING ==========
async function loadData() {
  document.getElementById('syncStatus').textContent = 'Loading...';
  let allC = [], allM = [], from = 0;
  while (true) {
    const { data } = await sb.from('growth_contacts').select('*').range(from, from + 999);
    if (!data || data.length === 0) break;
    allC = allC.concat(data);
    if (data.length < 1000) break;
    from += 1000;
  }
  from = 0;
  while (true) {
    const { data } = await sb.from('growth_meetings').select('*').range(from, from + 999);
    if (!data || data.length === 0) break;
    allM = allM.concat(data);
    if (data.length < 1000) break;
    from += 1000;
  }
  contacts = allC;
  meetings = allM;
  document.getElementById('syncStatus').textContent = `${contacts.length.toLocaleString()} contacts · ${meetings.length.toLocaleString()} meetings`;
  refresh();
}

// ========== SYNC ==========
async function callFunc(body) {
  const res = await fetch(FUNC_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + SUPABASE_KEY },
    body: JSON.stringify(body)
  });
  return res.json();
}

async function runSync() {
  const btn = document.getElementById('syncBtn');
  const overlay = document.getElementById('syncOverlay');
  const progress = document.getElementById('syncProgress');
  const detail = document.getElementById('syncDetail');
  const bar = document.getElementById('syncBar');

  btn.classList.add('syncing');
  btn.disabled = true;
  overlay.classList.add('show');

  try {
    // Step 1: Fetch list
    progress.textContent = 'Step 1/3: Fetching contact list...';
    detail.textContent = 'Getting contact IDs from HubSpot list';
    bar.style.width = '10%';

    const listResult = await callFunc({ step: 'list' });
    if (!listResult.success) throw new Error(listResult.error || 'List step failed');

    const totalIds = listResult.contact_ids_fetched || 0;
    progress.textContent = `Step 2/3: Syncing ${totalIds.toLocaleString()} contacts...`;
    bar.style.width = '20%';

    // Step 2: Batch contacts
    let batchStart = 0;
    let totalSynced = 0;
    let complete = false;

    while (!complete) {
      detail.textContent = `Processing batch ${batchStart.toLocaleString()} / ${totalIds.toLocaleString()}`;
      const pct = 20 + (batchStart / Math.max(totalIds, 1)) * 50;
      bar.style.width = pct + '%';

      const contactResult = await callFunc({ step: 'contacts', batch_start: batchStart });
      if (!contactResult.success) throw new Error(contactResult.error || 'Contacts step failed');

      totalSynced += contactResult.contacts_synced || 0;
      complete = contactResult.complete;

      if (!complete) {
        // Parse next batch_start from progress
        const match = contactResult.progress?.match(/^(\d+)/);
        batchStart = match ? parseInt(match[1]) : batchStart + 10000;
      }
    }

    progress.textContent = `Step 3/3: Syncing meetings...`;
    detail.textContent = `${totalSynced.toLocaleString()} contacts done, now fetching meetings`;
    bar.style.width = '80%';

    // Step 3: Meetings
    const meetResult = await callFunc({ step: 'meetings' });

    bar.style.width = '100%';
    progress.textContent = 'Sync complete!';
    detail.textContent = `${totalSynced.toLocaleString()} contacts · ${(meetResult.meetings_synced || 0).toLocaleString()} meetings`;

    await new Promise(r => setTimeout(r, 1500));

    // Reload data
    await loadData();

  } catch (err) {
    progress.textContent = 'Sync error';
    detail.textContent = err.message;
    await new Promise(r => setTimeout(r, 3000));
  } finally {
    overlay.classList.remove('show');
    btn.classList.remove('syncing');
    btn.disabled = false;
    bar.style.width = '0%';
  }
}

// ========== PERIOD UTILS ==========
function getWeekStart(d) { const dt=new Date(d); const day=dt.getUTCDay(); const diff=day===0?-6:1-day; dt.setUTCDate(dt.getUTCDate()+diff); return new Date(Date.UTC(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate())); }
function getPeriodKey(date) {
  const d=new Date(date);
  if(viewMode==='weekly'){const ws=getWeekStart(d);return ws.toISOString().split('T')[0];}
  return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}`;
}
function getCurrentPeriodKey() {
  const now=new Date();
  if(viewMode==='weekly'){const ws=getWeekStart(now);ws.setUTCDate(ws.getUTCDate()+periodOffset*7);return ws.toISOString().split('T')[0];}
  const m=now.getUTCMonth()+periodOffset;const y=now.getUTCFullYear()+Math.floor(m/12);const mo=((m%12)+12)%12;
  return `${y}-${String(mo+1).padStart(2,'0')}`;
}
function getPrevKey(k) {
  if(viewMode==='weekly'){const d=new Date(k+'T00:00:00Z');d.setUTCDate(d.getUTCDate()-7);return d.toISOString().split('T')[0];}
  const[y,m]=k.split('-').map(Number);const nm=m-1;const ny=nm<1?y-1:y;const mo=nm<1?12:nm;return `${ny}-${String(mo).padStart(2,'0')}`;
}
function formatPeriod(k) {
  if(viewMode==='weekly'){const d=new Date(k+'T00:00:00Z');const e=new Date(d);e.setUTCDate(e.getUTCDate()+6);const o={month:'short',day:'numeric',timeZone:'UTC'};return `${d.toLocaleDateString('en-US',o)} – ${e.toLocaleDateString('en-US',o)}, ${d.getUTCFullYear()}`;}
  const[y,m]=k.split('-');return new Date(Date.UTC(y,m-1,1)).toLocaleDateString('en-US',{month:'long',year:'numeric',timeZone:'UTC'});
}
function formatShort(k) {
  if(viewMode==='weekly'){const d=new Date(k+'T00:00:00Z');return d.toLocaleDateString('en-US',{month:'short',day:'numeric',timeZone:'UTC'});}
  const[y,m]=k.split('-');return new Date(Date.UTC(y,m-1,1)).toLocaleDateString('en-US',{month:'short',year:'2-digit',timeZone:'UTC'});
}

// ========== METRICS ==========
function filterC(list) {
  if(!document.getElementById('excludePartners').checked) return list;
  return list.filter(c=>!PARTNER_SOURCES.includes(c.attributed_source));
}

function calcMetrics(pk) {
  const fc=filterC(contacts);
  // MQLs = contacts CREATED in period with stage MQL, SQL, Opportunity, or Customer
  const mqlStages=['marketingqualifiedlead','salesqualifiedlead','opportunity','99994170','customer'];
  const mqls=fc.filter(c=>{
    if(!c.create_date||getPeriodKey(c.create_date)!==pk) return false;
    return mqlStages.includes(c.lifecycle_stage);
  }).length;
  // SQLs = contacts CREATED in period with stage SQL, Opportunity, or Customer
  const sqlStages=['salesqualifiedlead','opportunity','99994170','customer'];
  const sqls=fc.filter(c=>{
    if(!c.create_date||getPeriodKey(c.create_date)!==pk) return false;
    return sqlStages.includes(c.lifecycle_stage);
  }).length;
  // Meetings by created_date (when scheduled)
  const mtgs=meetings.filter(m=>{
    const d=m.created_date||m.start_time;
    return d&&getPeriodKey(d)===pk;
  }).length;
  // Sits = completed meetings
  const sits=meetings.filter(m=>{
    if(!m.start_time||getPeriodKey(m.start_time)!==pk) return false;
    const o=(m.outcome||'').toLowerCase().replace(/[_:]/g,' ');
    return o.includes('completed')||o.includes('not needed')||o.includes('docs needed');
  }).length;
  // Closes (by create date) = customers CREATED in period
  const closesCreated=fc.filter(c=>{
    if(c.lifecycle_stage!=='customer') return false;
    return c.create_date&&getPeriodKey(c.create_date)===pk;
  }).length;
  // Closes (by deal close date) = contacts whose recent_deal_close_date falls in period
  const closesDeal=fc.filter(c=>{
    return c.recent_deal_close_date&&getPeriodKey(c.recent_deal_close_date)===pk;
  }).length;
  return {mqls,sqls,mtgs,sits,closesCreated,closesDeal};
}

// ========== RENDERERS ==========
function renderKPIs(cur,prev) {
  const cards=[{l:'MQLs',k:'mqls'},{l:'SQLs',k:'sqls'},{l:'Meetings',k:'mtgs'},{l:'Sits',k:'sits'},{l:'Closes (Created)',k:'closesCreated'},{l:'Closes (Won)',k:'closesDeal'}];
  document.getElementById('kpiGrid').innerHTML=cards.map(c=>{
    const v=cur[c.k],p=prev[c.k];
    let ct='—',cc='flat';
    if(p>0){const pct=Math.round(((v-p)/p)*100);ct=pct>0?`+${pct}%`:`${pct}%`;cc=pct>0?'up':pct<0?'down':'flat';}
    else if(v>0){ct='+∞';cc='up';}
    return `<div class="kpi-card"><div class="kpi-label">${c.l}</div><div class="kpi-value">${v.toLocaleString()}</div><div class="kpi-change ${cc}">${ct}</div><div class="kpi-prev">prev: ${p.toLocaleString()}</div></div>`;
  }).join('');
}

function renderFunnel(m) {
  const stages=[{n:'MQLs',v:m.mqls,c:'var(--accent)'},{n:'SQLs',v:m.sqls,c:'var(--accent2)'},{n:'Meetings',v:m.mtgs,c:'var(--accent3)'},{n:'Sits',v:m.sits,c:'var(--purple)'},{n:'Closes',v:m.closesDeal,c:'var(--pink)'}];
  const mx=Math.max(...stages.map(s=>s.v),1);
  let h='';
  for(let i=0;i<stages.length;i++){
    const s=stages[i],pct=Math.max((s.v/mx)*100,8);
    h+=`<div class="funnel-stage"><div class="funnel-stage-name">${s.n}</div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:${pct}%;background:${s.c}"><span class="funnel-bar-label">${s.v.toLocaleString()}</span></div></div></div>`;
    if(i<stages.length-1&&stages[i].v>0){h+=`<div class="funnel-arrow">↓ ${Math.round((stages[i+1].v/stages[i].v)*100)}%</div>`;}
  }
  document.getElementById('funnel').innerHTML=h;
}

function renderTrend() {
  const n=viewMode==='weekly'?12:6;
  const periods=[];let k=getCurrentPeriodKey();
  for(let i=0;i<n;i++){periods.unshift(k);k=getPrevKey(k);}
  const data=periods.map(p=>calcMetrics(p));
  const labels=periods.map(formatShort);

  const metricConfigs = [
    { id: 'chartMqls', key: 'mqls', color: '#22d3a7', label: 'MQLs' },
    { id: 'chartSqls', key: 'sqls', color: '#3b82f6', label: 'SQLs' },
    { id: 'chartMtgs', key: 'mtgs', color: '#f59e0b', label: 'Meetings' },
    { id: 'chartSits', key: 'sits', color: '#a855f7', label: 'Sits' },
    { id: 'chartClosesCreated', key: 'closesCreated', color: '#ec4899', label: 'Closes (Created)' },
    { id: 'chartClosesDeal', key: 'closesDeal', color: '#f43f5e', label: 'Closes (Won)' }
  ];

  metricConfigs.forEach(cfg => {
    if (charts[cfg.id]) charts[cfg.id].destroy();
    const ctx = document.getElementById(cfg.id).getContext('2d');
    const values = data.map(d => d[cfg.key]);

    charts[cfg.id] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: cfg.label,
          data: values,
          backgroundColor: cfg.color + '99',
          borderColor: cfg.color,
          borderWidth: 1,
          borderRadius: 4,
          barPercentage: 0.7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1a2234',
            titleColor: '#e2e8f0',
            bodyColor: '#e2e8f0',
            borderColor: '#1e2d44',
            borderWidth: 1,
            bodyFont: { family: 'Space Mono', size: 11 }
          },
          datalabels: false
        },
        layout: { padding: { top: 20 } },
        scales: {
          x: { ticks: { color: '#8896aa', font: { family: 'DM Sans', size: 10 } }, grid: { color: '#1e2d44' } },
          y: { ticks: { color: '#8896aa', font: { family: 'Space Mono', size: 10 } }, grid: { color: '#1e2d44' }, beginAtZero: true }
        },
        animation: {
          onComplete: function() {
            const chartInstance = this;
            const ctx2 = chartInstance.ctx;
            ctx2.font = "bold 11px 'Space Mono', monospace";
            ctx2.fillStyle = '#e2e8f0';
            ctx2.textAlign = 'center';
            ctx2.textBaseline = 'bottom';
            const meta = chartInstance.getDatasetMeta(0);
            meta.data.forEach((bar, i) => {
              const val = values[i];
              if (val > 0) ctx2.fillText(val.toLocaleString(), bar.x, bar.y - 4);
            });
          }
        }
      }
    });
  });
}

function renderTable() {
  const n=viewMode==='weekly'?12:6;
  const periods=[];let k=getCurrentPeriodKey();
  for(let i=0;i<n;i++){periods.unshift(k);k=getPrevKey(k);}
  const data=periods.map(p=>({key:p,...calcMetrics(p)}));
  const maxM=Math.max(...data.map(d=>d.mqls),1);
  document.getElementById('tableTitle').textContent=viewMode==='weekly'?'Breakdown by Week':'Breakdown by Month';
  document.getElementById('tableHead').innerHTML='<tr><th>Period</th><th>MQLs</th><th>SQLs</th><th>Meetings</th><th>Sits</th><th>Closes (Created)</th><th>Closes (Won)</th><th>MQL→SQL</th><th>Mtg→Sit</th></tr>';
  document.getElementById('tableBody').innerHTML=data.map(d=>{
    const label=formatPeriod(d.key);
    const bw=Math.max((d.mqls/maxM)*60,2);
    const r1=d.mqls>0?Math.round((d.sqls/d.mqls)*100)+'%':'—';
    const r2=d.mtgs>0?Math.round((d.sits/d.mtgs)*100)+'%':'—';
    return `<tr><td style="font-family:var(--font);font-weight:500;font-size:13px">${label}</td><td><span class="mini-bar" style="width:${bw}px;background:var(--accent)"></span>${d.mqls}</td><td>${d.sqls}</td><td>${d.mtgs}</td><td>${d.sits}</td><td>${d.closesCreated}</td><td>${d.closesDeal}</td><td>${r1}</td><td>${r2}</td></tr>`;
  }).join('');
}

function refresh() {
  const ck=getCurrentPeriodKey(),pk=getPrevKey(ck);
  renderKPIs(calcMetrics(ck),calcMetrics(pk));
  renderFunnel(calcMetrics(ck));
  renderTrend();
  renderTable();
  document.getElementById('periodLabel').textContent=formatPeriod(ck);
}

function setView(mode) {
  viewMode=mode;periodOffset=0;
  document.querySelectorAll('.period-toggle button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  refresh();
}

function navigatePeriod(dir){periodOffset+=dir;refresh();}

loadData();
</script>
</body>
</html>
